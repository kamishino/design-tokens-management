# AGENTS.md

> Operational guide for AI agents in this repository.
> Focus: predictable execution, KamiFlow artifacts, and strict task closure.

## Purpose

This project uses specialized agents with a KamiFlow-style lifecycle.  
Every meaningful task should be traceable from idea to handoff with clear artifacts and verifiable outcomes.

## Rule Source Of Truth

Codex must treat these as mandatory project policy:

1. `AGENTS.md` (this file) — workflow + closure contract.
2. `.agent/config.json` — active `guardRails` and workflow registry.
3. `.agent/rules/*.md` — rule documents listed under `guardRails`.
4. `.agent/workflows/*.md` — execution patterns for commands like `/kamiflow`.

If there is a conflict, follow instruction priority from runtime (system/developer), then apply this project policy.

## Core Workflow (KamiFlow)

Use this sequence for feature or bug work:

1. `S1 IDEA`
- Clarify objective, constraints, risks, and acceptance criteria.
- Output: `.kamiflow/tasks/<ID>-S1-IDEA-<slug>.md`

2. `S2 SPEC`
- Define implementation plan, files touched, test plan, rollback plan.
- Output: `.kamiflow/tasks/<ID>-S2-SPEC-<slug>.md`

3. `S3 BUILD`
- Implement changes incrementally.
- Keep commits scoped and reversible.
- Output: `.kamiflow/tasks/<ID>-S3-BUILD-<slug>.md`

4. `S4 HANDOFF`
- Summarize what shipped, validation evidence, residual risks, and next actions.
- Output: `.kamiflow/tasks/<ID>-S4-HANDOFF-<slug>.md`

## Task Intake Gate (Before S1)

Classify the request before starting work:

- Use `/quick-fix` only when **all 5** are true:
  - Single file affected
  - < 50 lines of change
  - No API/schema changes
  - No security implications
  - No cross-module dependencies
- Otherwise, default to `/kamiflow` with full S1-S4 artifacts.
- If uncertain, treat as meaningful work and use `/kamiflow`.

### Task Artifact Requirement

For every S1-S4 file, include a `## Rules Applied` section that lists which `.agent/rules/*` documents were applied and how.

## Agent Roles (Recommended Routing)

- `planner`: scope, breakdown, sequencing, estimates.
- `architect`: boundaries, abstractions, refactors, design tradeoffs.
- `debugger`: root cause analysis and bug isolation.
- `Tester`: test strategy, coverage, flaky test hardening.
- `reviewer`: code quality, regression checks, PR risk review.
- `shipper`: release notes, versioning, deployment readiness.
- `writer` / `Documentation Writer`: READMEs, guides, changelog, ADR updates.
- `Security Auditor`: threat/risk checks, secret handling, auth/security review.

## Task Closure Protocol (Mandatory)

Before marking a task complete, agents must do all of the following:

1. Update tracker
- Update `.memory/todo.md` with `In Progress`, `Pending`, `Completed` deltas.

2. Run validation
- Minimum: `npm run test`.
- For feature/infrastructure/build-impacting changes: `npm run build`.

3. Keep commits task-scoped
- Commit only files related to the task.
- Do not include unrelated local changes.
- Only commit when the user explicitly requests a commit.

4. Report closure evidence
- Provide:
  - files changed
  - tests/build results
  - commit hash
  - remaining open items

Automation commands:
- `npm run task:start -- --task=<ID> --slug=<slug> [--title="..."]` scaffolds S1-S4 artifacts and updates `.memory/todo.md`.
- `npm run task:verify` checks tracker + optional KamiFlow artifacts.
- `npm run task:close` runs test, build, then verification.
- Optional: `npm run task:verify -- --task=<ID>` enforces S1-S4 artifacts and per-phase section requirements for a task ID.
- Optional: `npm run task:verify -- --task=<ID> --no-strict` downgrades to compatibility checks for legacy artifacts.
- With `--task=<ID>`, verification also enforces guard-rail references from `.agent/config.json`.

## Commit Convention

Preferred format:

`<type>(<scope>): <description> (Task <ID>)`

Examples:
- `feat(export): add figma pre-export validation gate (Task 141)`
- `fix(workspace): block global token delete in UI (Task 142)`
- `test(sync): add global guard route coverage (Task 143)`

## Safety Rules

- Never run destructive git commands unless explicitly requested.
- Never revert unrelated user changes.
- Never auto-commit based on workflow text; prepare commit content and wait for explicit user request.
- Preserve path safety checks for file I/O.
- For global token operations, keep restore/backup mechanisms intact.

## Project Conventions

- Use feature-oriented structure under `src/`.
- Keep token references path-stable and deterministic.
- API errors should be structured JSON with `error` + `code`.
- Prefer explicit validation and guardrails over implicit behavior.

## Maintenance

If agent registry is regenerated by `agk agents`, re-apply this workflow policy section to keep operational consistency.
